name: Release

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download c3c
        if: runner.os == 'Linux'
        run: |
          curl -L -o c3.tar.gz https://github.com/c3lang/c3c/releases/download/v0.7.9/c3-linux.tar.gz
          tar xzf c3.tar.gz
          echo "C3C_LIB=$PWD/c3/lib" >> $GITHUB_ENV

      - name: Download c3c
        if: runner.os == 'macOS'
        run: |
          curl -L -o c3.tar.gz https://github.com/c3lang/c3c/releases/download/v0.7.9/c3-macos.zip
          tar xzf c3.tar.gz
          # cp -r macos c3
          echo "C3C_LIB=$PWD/c3/lib" >> $GITHUB_ENV

      - name: Ensure LLVM / lld available (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install llvm || true
          # Some c3c builds expect /opt/homebrew/opt/lld; point it to the llvm keg.
          if [ ! -d /opt/homebrew/opt/lld ]; then
            sudo ln -s /opt/homebrew/opt/llvm /opt/homebrew/opt/lld || true
          fi

      - name: Download c3c
        if: runner.os == 'Windows'
        run: |
          curl -L -o c3.zip https://github.com/c3lang/c3c/releases/download/v0.7.9/c3-windows.zip
          unzip c3.zip
          # cp -r c3-windows-Release c3
          echo "C3C_LIB=$PWD/c3/lib" >> $GITHUB_ENV

      - name: Install tree-sitter
        uses: lmichaudel/ts-setup-action@master
        with:
          install-lib: true
          install-cli: false
          
      - name: Build c3fmt
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: ./c3/c3c build -L "$RUNNER_TOOL_CACHE/tree-sitter/lib/lib"

      - name: Build c3fmt
        if: runner.os == 'Windows'
        shell: bash
        run: ./c3/c3c.exe build -L "$RUNNER_TOOL_CACHE/tree-sitter/lib/lib"

      - name: Upload artefact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
            name: c3fmt-linux
            path: build/c3fmt

      - name: Upload artefact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
            name: c3fmt-macos
            path: build/c3fmt

      - name: Upload artefact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
            name: c3fmt.exe
            path: build/c3fmt.exe
